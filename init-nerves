#!/bin/sh

set +e

PATH=/sbin:/bin:/usr/sbin:/usr/bin
export PATH

BB=/bin/busybox

SERIAL=/dev/ttyS0
ROOT_DEV=/dev/mmcblk0p10
ONBOARD_DEV=/dev/mmcblk0p12

PUSH_DEV=/dev/input/event1
ONBOARD_MNT=/mnt/onboard
NEWROOT=/mnt/newroot
MERGED=/mnt/merged
IMAGE_PATH=.buildroot/buildroot-kobo.img

BUILDROOT_ATTEMPTED=0

log() {
    echo "kobo-init: $*"
}

cleanup() {
    losetup -d /dev/loop0
    umount -l "$MERGED" >/dev/null 2>&1 || umount "$MERGED" >/dev/null 2>&1 || :
    umount -l "$NEWROOT" >/dev/null 2>&1 || umount "$NEWROOT" >/dev/null 2>&1 || :
    umount -l "$ONBOARD_MNT" >/dev/null 2>&1 || umount "$ONBOARD_MNT" >/dev/null 2>&1 || :
}

push_detected() {
    log "checking for push event on $PUSH_DEV (max 10s)"
    i=0
    while [ ! -e "$PUSH_DEV" ] && [ $i -lt 50 ]; do
        "$BB" sleep 0.2 2>/dev/null || sleep 0.2
        i=$((i + 1))
    done
    [ -e "$PUSH_DEV" ] || return 1

    "$BB" timeout -s TERM 10 "$BB" dd if="$PUSH_DEV" of=/dev/null bs=24 count=1 >/dev/null 2>&1
    [ $? -eq 0 ]
}

try_boot() {
    [ -w /tmp ] || return 1

    mkdir -p /proc /sys /dev /tmp /mnt /dev/input "$ONBOARD_MNT" "$NEWROOT" "$MERGED" >/dev/null 2>&1 || return 1
    mount -t proc proc /proc 2>/dev/null || :
    mount -t sysfs sysfs /sys 2>/dev/null || :
    mount -t devtmpfs devtmpfs /dev 2>/dev/null || :
    mount -o remount,noatime,nodiratime "$ROOT_DEV" / 2>/dev/null || :
    mount -t tmpfs -o mode=1777,nosuid,nodev tmpfs /tmp 2>/dev/null || :

    [ -b "$ONBOARD_DEV" ] || return 1
    mount -t vfat -o rw,noatime,nodiratime,shortname=mixed,utf8 "$ONBOARD_DEV" "$ONBOARD_MNT" >/dev/null 2>&1 || return 1

    log "image"
    img="$ONBOARD_MNT/$IMAGE_PATH"
    [ -f "$img" ] || return 1

    log "insmod"
    insmod /mnt/onboard/.buildroot/modules/4.9.77/kernel/fs/squashfs/squashfs.ko 
    insmod /mnt/onboard/.buildroot/modules/4.9.77/kernel/fs/f2fs/f2fs.ko

    log "losetup"
    losetup -Pf "$img" || return 1

    log "mount loop0p1"
    mount -o ro /dev/loop0p1 "$NEWROOT" || return 1

    # --- tmpfs copy for writable root ---
    log "mount tmpfs for writable root"
    mkdir -p "$MERGED"
    mount -t tmpfs tmpfs "$MERGED" || return 1
    log "copy SquashFS root into tmpfs"
    cp -a "$NEWROOT/." "$MERGED/" || return 1

    # --- pivot root ---
    mkdir -p "$MERGED/.oldroot" "$MERGED/proc" "$MERGED/sys" "$MERGED/dev"
    cd "$MERGED" 2>/dev/null || return 1
    log "pivot_root"
    pivot_root . .oldroot >/dev/null 2>&1 || return 1
    cd / 2>/dev/null || :

    log "setup /dev"
    mount -t devtmpfs devtmpfs /dev
    mkdir -p /dev/pts /dev/shm
    mount -t devpts devpts /dev/pts
    mount -t tmpfs tmpfs /dev/shm
    mknod /dev/null c 1 3
    mknod /dev/console c 5 1

    log "move mounts"
    mount --move /.oldroot/proc /proc
    mount --move /.oldroot/sys /sys

    log "cleanup old root"
    mkdir -p /mnt/onboard
    mount --move /.oldroot/mnt/onboard /mnt/onboard
    # Now clean up the old root (but onboard is preserved)
    umount -l /.oldroot 2>/dev/null || :

    log "exec /sbin/init"
    exec /sbin/init
}

main() {
    if [ -c "$SERIAL" ]; then
        exec >"$SERIAL" 2>&1
    elif [ -e /dev/kmsg ]; then
        exec >/dev/kmsg 2>&1
    elif [ -e /dev/console ]; then
        exec >/dev/console 2>&1
    fi

    trap 'if [ "$BUILDROOT_ATTEMPTED" -eq 1 ]; then cleanup; fi; exec "$BB" init "$@"' 0

    log "starting"
    if push_detected; then
        log "push detected"
        BUILDROOT_ATTEMPTED=1
        try_boot || { log "alternative boot failed"; cleanup; }
    fi
    exec "$BB" init "$@"
}

main "$@"


